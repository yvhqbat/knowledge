# redis在项目中的应用
参考：
- 《redis实战》

## 1. 服务注册与发现、配置管理
使用Redis存储配置信息，以`config:appname:...`为key，以JSON编码的配置信息为value，提供SetConfig/GetConfig接口。



## 2. 分布式锁
应用场景：对象存储项目中，多个接入节点都可以创建bucket，但由于容量、bucket不能重复等限制，一次只能创建一个bucket，需要用到分布式锁。

使用Redis构建分布式锁，`SETNX`命令适合用来实现锁的获取功能，这个命令只会在键不存在的情况下设置值，而值则是一个UUID，防止锁被其他进程获取。

为了防止锁的持有者崩溃而导致的不会自动释放锁，需要对锁添加超时功能。在获得锁后，使用`EXPIRE`命令来为锁设置过期时间，使得Redis能够自动释放超时的锁。

为了确保锁在持有者崩溃后仍能自动被释放，客户端需要在尝试获取锁失败后，检查所得超时时间，并为未设置超时时间的锁设置超时时间。

## 3. 任务队列
由于任务耗时较多，先将任务放入到**任务队列**中，然后由**任务处理器**来执行任务。

专门的任务队列组件有：ActiveMQ, RabbitMQ等。

主要介绍三种任务队列：
- 先进先出队列，按照任务插入队列的顺序来执行；
- 优先级队列，多个队列组成；
- 延迟任务，安排任务在未来的某个时间执行；


### 3.1 先进先出队列
使用Redis的列表实现，具体命令有： RPUSH, RPOP, LPUSH, LPOP, BLPOP, BRPOP。

列表中保持JSON编码的任务信息，任务的格式可以是
`
"FUNCTION_NAME",
[ARG1, ARG2, ...]
`

### 3.2 优先级队列
    比如需要使用高、中、低 3 种优先级的队列，可以使用3个队列来实现。

### 3.2 延迟任务
    延迟任务，安排任务在未来的某个时间执行。比如某些资源在某个时间过期，可以采用延迟任务进行删除。

Redis中的有序集合 ZSET 能够实现延迟任务。
延迟任务是一个包含4个值得JSON列表，这4个值分别是：唯一标识符、处理任务的队列的名字、处理任务的回调函数的名字、传给回调函数的参数。
在有序集合中，分值设置为任务的执行时间，可立即执行的任务被直接插入到任务队列中。

## 4. 缓存
分布式对象存储项目中，每一个请求都需要进行用户鉴权，用户信息是保存在mysql数据库中的，但如果每个请求都访问一次数据库，那么会对数据库造成大量的并发操作。所以，采用redis作为缓存，① 利用redis的高并发、高性能的优势； ② 缓存热点用户的信息，用户信息会保存30mins过期；


